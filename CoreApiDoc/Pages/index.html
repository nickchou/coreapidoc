<!DOCTYPE html>
<html>
<head>
    <title>core api文档生成工具</title>
    <meta charset='UTF-8'>
    <link rel='stylesheet' href='https://unpkg.com/element-ui/lib/theme-chalk/index.css'>
    <script src='https://cdn.bootcss.com/jquery/2.0.0/jquery.min.js'></script>
    <script src='https://nickchou.github.io/script/beautify/v1.8.9/beautify.js'></script>
    <link rel='stylesheet' href='https://nickchou.github.io/script/prismjs/v1.5/prism.css'>
    <script type="text/javascript">
        var baseURL = "{currUrl}";
        function getUrlParam(name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
            var r = window.location.search.substr(1).match(reg);
            if (r != null) return unescape(r[2]); return "";
        }
    </script>
</head>

<body>
    <div id='app'>
        <el-row>
            <el-col :span='5'>
                <el-select v-model='selApi' filterable placeholder='请选择' style='width:100%;' @change='getApi'>
                    <el-option v-for='item in opsApi' :key='item.value' :label='item.label' :value='item.value'>
                    </el-option>
                </el-select>
            </el-col>
            <el-col :span='1'>&nbsp;</el-col>
            <el-col :span='8'>
                <el-select v-model='selCtrl' filterable placeholder='请选择' style='width:100%;' @change='getMethod'>
                    <el-option v-for='item in opsCtrl' :key='item.value' :label='item.label' :value='item.value'>
                    </el-option>
                </el-select>
            </el-col>
            <el-col :span='1'>&nbsp;</el-col>
            <el-col :span='9'>
                <el-select v-model='selAction' filterable placeholder='请选择' style='width:100%;' @change='initParam'>
                    <el-option v-for='item in opsAction' :key='item.value' :label='item.label' :value='item.value'>
                    </el-option>
                </el-select>
            </el-col>
            <!--<el-col :span='1'>&nbsp;</el-col>
            <el-col :span='3'>
                <el-button type='primary' @click='btnGetInfo'>GET INFO</el-button>
            </el-col>-->
        </el-row>
        <el-row style='height: 10px;'></el-row>
        <el-row style='height: 20px;'><el-col :span='24'>{{currURL}}</el-col></el-row>
        <el-row style='height: 10px;'></el-row>
        <el-row>
            <el-tabs type='border-card' style=''>
                <el-tab-pane label='API请求JSON'>
                    <!-- <pre name='code' class='brush: js; gutter: false;'>{{aa}}</pre> -->
                    <pre><code id='codeReq' class='language-javascript line-numbers'></code></pre>
                </el-tab-pane>
                <el-tab-pane label='API响应JSON'>
                    <pre><code id='codeRes' class='language-javascript line-numbers'></code></pre>
                </el-tab-pane>
                <el-tab-pane label='接口参数说明'>待完善...</el-tab-pane>
                <el-tab-pane label='API接口调试'>待完善...</el-tab-pane>
            </el-tabs>
        </el-row>
    </div>

</body>
<script type="text/javascript" src='https://unpkg.com/vue/dist/vue.js'></script>
<script type="text/javascript" src='https://unpkg.com/element-ui/lib/index.js'></script>
<script type="text/javascript" src='https://unpkg.com/axios/dist/axios.min.js'></script>
<script type="text/javascript">
    new Vue({
        el: '#app',
        data: {
            opsApi: [],
            selApi: '' /*程序集选择项*/,
            opsCtrl: [] /*api数据源*/,
            selCtrl: '' /*api选项*/,
            opsAction: [] /*action数据源*/,
            selAction: '' /*action选项*/,
            jsonApi: [] /*api总数据*/,
            jsonActions: [] /*action的具体信息*/,
            currURL:""
        },
        filters: {
            json: function (data) {
                var json = JSON.stringify(data);
                return JSON.parse(json);
            }
        },
        methods: {
            getApi: function () {
                var para = new URLSearchParams();
                para.append('asb', this.selApi);
                axios.get(baseURL +'/getapi?asb=' + this.selApi)
                    .then(resp => {
                        var list = [];
                        var listAss = [];
                        /*API程序集*/
                        resp.data.forEach(element => {
                            listAss.push({
                                value: element.NameSpace,
                                label: element.NameSpace
                            });
                        });
                        this.opsApi = listAss;
                        if (this.selApi == '') {
                            this.selApi = listAss[0].value;
                        }
                        /*API接口的*/
                        resp.data[0].Apis.forEach(e => {
                            list.push({
                                value: e.Name,
                                label: e.Name + '-' + e.Desc
                            });
                        });
                        this.jsonApi = resp.data;
                        this.opsCtrl = list;
                        if (this.selCtrl == '') {
                            this.selCtrl = list[0].value;
                        }
                        this.getMethod();
                    }).catch(function (error) {
                        alert(error);
                    });
            },
            getMethod: function () {
                this.jsonActions = this.jsonApi[0].Apis.find(q => q.Name == this.selCtrl);
                if (this.jsonActions.Funs.length > 0) {
                    this.opsAction = this.jsonActions.Funs.map(key => {
                        return {
                            value: key.Name,
                            label: key.Name + '-' + key.Desc
                        }
                    });
                    if (this.selAction == '') {
                        this.selAction = this.opsAction[0].value;
                    }
                } else {
                    /*当api接口中没有方法的时候置空*/
                    this.selAction = '';
                    this.opsAction = [];
                    this.initCurrUrl();
                }
                //重新加载下接口文档
                this.initParam();
            },
            initParam: function () {
                $('#codeReq').html('');//请求参数要重新初始化一下
                $('#codeRes').html('');//响应参数要重新初始化一下
                //ajax获取方法的参数等信息
                //console.log(this.selApi + "," + this.selCtrl + "," + this.selAction);
                if (this.selAction == "") return;
                axios.get(baseURL + '/getparam?asb=' + this.selApi + '&ctrl=' + this.selCtrl + '&action=' + this.selAction).then(res => {
                    if (res.data.Code == 200) {
                        $('#codeReq').html(this.ToBeautify(res.data.ReqParam));
                        $('#codeRes').html(this.ToBeautify(res.data.ResParam));
                        $.getScript('https://nickchou.github.io/script/prismjs/v1.5/prism.js');
                    } else {
                        alert(res.data.Msg);
                    }
                }).catch(function (error) {
                    alert('获取参数异常' + error);
                    });
                this.initCurrUrl();
                
            },
            initCurrUrl: function () {
                this.currURL = baseURL + "?asb=" + this.selApi + "&ctrl=" + this.selCtrl + "&action=" + this.selAction;
            },
            ToBeautify: function (json) {
                if (typeof json == 'object') {
                    json = JSON.stringify(json);
                }
                strFormat = js_beautify(json, {
                    'indent_size': 1,
                    'indent_char': '\t'
                });
                return strFormat;
            }
        },
        mounted() {
            this.selApi = getUrlParam("asb");
            this.selCtrl = getUrlParam("ctrl");
            this.selAction = getUrlParam("action");
            console.log(this.selApi + "," + this.selCtrl + "," + this.selAction);
            this.getApi();
        },
    });
</script>

</html>