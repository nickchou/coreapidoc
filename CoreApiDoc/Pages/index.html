<!DOCTYPE html>
<html>
<head>
    <title>orderpublic.api文档工具</title>
    <meta charset='UTF-8'>
    <link rel='stylesheet' href='https://unpkg.com/element-ui/lib/theme-chalk/index.css'>
    <script src='https://cdn.bootcss.com/jquery/2.0.0/jquery.min.js'></script>
    <script src='https://nickchou.github.io/script/beautify/v1.8.9/beautify.js'></script>
    <link rel='stylesheet' href='https://nickchou.github.io/script/prismjs/v1.5/prism.css'>

</head>

<body>
    <div id='app'>
        <el-row>
            <el-col :span='5'>
                <el-select v-model='selApi' filterable disabled placeholder='请选择' style='width:100%;'>
                    <el-option v-for='item in opsApi' :key='item.value' :label='item.label' :value='item.value'>
                    </el-option>
                </el-select>
            </el-col>
            <el-col :span='1'>&nbsp;</el-col>
            <el-col :span='8'>
                <el-select v-model='selCtrl' filterable placeholder='请选择' style='width:100%;' @change='getMethod'>
                    <el-option v-for='item in opsCtrl' :key='item.value' :label='item.label' :value='item.value'>
                    </el-option>
                </el-select>
            </el-col>
            <el-col :span='1'>&nbsp;</el-col>
            <el-col :span='5'>
                <el-select v-model='selAction' filterable placeholder='请选择' style='width:100%;' @change='initParam'>
                    <el-option v-for='item in opsAction' :key='item.value' :label='item.label' :value='item.value'>
                    </el-option>
                </el-select>
            </el-col>
            <el-col :span='1'>&nbsp;</el-col>
            <el-col :span='3'>
                <el-button type='primary' @click='btnGetInfo'>GET INFO</el-button>
            </el-col>
        </el-row>
        <el-row style='height: 20px;'></el-row>
        <el-row>
            <el-tabs type='border-card' style=''>
                <el-tab-pane label='API请求JSON'>
                    <!-- <pre name='code' class='brush: js; gutter: false;'>{{aa}}</pre> -->
                    <pre><code id='code1' class='language-javascript line-numbers'></code></pre>
                </el-tab-pane>
                <el-tab-pane label='API响应JSON'>
                    <pre><code id='code2' class='language-javascript line-numbers'></code></pre>
                </el-tab-pane>
                <el-tab-pane label='接口参数说明'>待完善...</el-tab-pane>
                <el-tab-pane label='API接口调试'>待完善...</el-tab-pane>
            </el-tabs>
        </el-row>
    </div>

</body>
<script src='https://unpkg.com/vue/dist/vue.js'></script>
<script src='https://unpkg.com/element-ui/lib/index.js'></script>
<script src='https://unpkg.com/axios/dist/axios.min.js'></script>
<script>
    new Vue({
        el: '#app',
        data: {
            opsApi: [{
                value: 'tcgl.netcore.orderpublic.api',
                label: 'tcgl.netcore.orderpublic.api'
            }],
            selApi: '',
            /*api选择项*/
            opsCtrl: [],
            /*api数据源*/
            selCtrl: '',
            /*controller选项*/
            opsAction: [],
            /*controller数据源*/
            selAction: '',
            /*action选项*/
            jsonApi: [],
            /*api总数据*/
            jsonActions: [],
            /*action的具体信息*/
        },
        filters: {
            json: function (data) {
                var json = JSON.stringify(data);
                return JSON.parse(json);
            }
        },
        methods: {
            getMethod: function () {
                var list = [];
                this.jsonActions = this.jsonApi.Contorls.find(q => q.Name == this.selCtrl);
                //console.log(this.jsonActions);
                this.opsAction = this.jsonActions.Funs.map(key => {
                    return {
                        value: key.Name,
                        label: key.Name
                    }
                });
                this.selAction = this.opsAction[0].value;
            },
            initParam: function () {
                //这里啥也不用做，点按钮的时候再去做
                //this.jsonActions.Funs.find(q => q.Name == this.selAction);
            },
            btnGetInfo: function () {
                $('#code1').html('');//这里要重新初始化一下
                $('#code2').html('');//这里要重新初始化一下
                var currAction = this.jsonActions.Funs.find(q => q.Name == this.selAction);
                /*1、生成前端需要的请求参数*/
                if (currAction.ReqParams.length == 1) {
                    var params1 = new URLSearchParams();
                    params1.append('nameSpace', currAction.ReqParams[0].NameSpace);
                    params1.append('filePath', currAction.ReqParams[0].FileName);
                    axios.post('/travel/orderpublicapi/ApiComm/ModelToJson', params1).then(res => {
                        /*在这里格式化js代码*/
                        $('#code1').html(this.ToBeautify(res.data));
                    }).catch(function (error) {
                        alert('response参数错误' + error);
                    });
                } else if (currAction.ReqParams.length == 0) {
                    $('#code1').html('无请求参数...');
                } else {
                    $('#code1').html('请求参数太多,无法自动生成，请检查...');
                }
                /*2、生成前端需要的返回参数*/
                var params2 = new URLSearchParams();
                params2.append('nameSpace', currAction.ResParams.NameSpace);
                params2.append('filePath', currAction.ResParams.FileName);
                axios.post('/travel/orderpublicapi/ApiComm/ModelToJson', params2).then(res => {
                    /*在这里格式化js代码*/
                    $('#code2').html(this.ToBeautify(res.data));
                }).catch(function (error) {
                    alert('response参数错误' + error);
                });
                $.getScript('https://nickchou.github.io/script/prismjs/v1.5/prism.js', function () {
                    console.log('load prism.js');
                });
            },
            ToBeautify: function (json) {
                if (typeof json == 'object') {
                    json = JSON.stringify(json);
                }
                strFormat = js_beautify(json, {
                    'indent_size': 1,
                    'indent_char': '\t'
                });
                return strFormat;
            }
        },
        mounted() {
            this.selApi = this.opsApi[0].value;
            axios
                .get('/travel/orderpublicapi/ApiComm/GetController')
                .then(resp => {
                    var list = [];
                    resp.data.Contorls.forEach(element => {
                        list.push({
                            value: element.Name,
                            label: element.Name
                        });
                    });
                    this.jsonApi = resp.data;
                    this.opsCtrl = list;
                    this.selCtrl = list[0].value;
                    this.getMethod();
                }).catch(function (error) {
                    alert(error);
                });
        },
    });
</script>

</html>